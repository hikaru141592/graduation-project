require "line/bot"

class SeasonalNotificationJob < ApplicationJob
  queue_as :default

  SCHEDULE = {
    "1-10-11"   => "にににー、ににに！\nにににににー、にっににに、んににに！\nににー、んにににー！\n----（訳）----\n最近はボール遊びにハマってるよ！\nなかなかうまくキャッチできないときもあるけど、そっちだよって言ってくれるときれいにとれるんだ！\nもっと練習しよー！",
    "2-3-13"  => "ににー！\nにーにに、にににーに～！\nににに、んにににに～！\n----（訳）----\n今日も寒ーい！\nこんなに寒いとおうちから出られないよ～！\n今日もこたつでゆっくり過ごそうかな～！",
    "2-24-17"  => "にににーににに？\nんににに、にににににー！\nにーにに、にににーにー！\n----（訳）----\n君は好きなテレビ番組ってあるー？\n僕は毎週水曜日の20時からやってる「ニワトリビアの湖」が好きだよ！\n毎週楽しみなんだー！",
    "3-16-9"   => "ににににんにに！\nにににに、んににに～！\nにににー、にににーに！\n----（訳）----\nそろそろ春が来るね！\n今年もお花見いけるかな～！\nきれいな桜が見れたらいいな！",
    "4-1-8"   => "ににに！\nんにに、にににー！\nにーにににににー！\n----（訳）----\n今日から新学期！\n何か新しい出会いが待ってるかもー！\n今年度も頑張っていこうね！",
    "5-4-11"   => "にににーにーににに！\nにーにに、にににーにに、にににーんにににに！\nにーに、にーにににににーに！\n----（訳）----\n僕は最近算数の勉強を頑張ってるんだ！\n計算ミスしちゃうこともあるけど、少しずつ早く計算できるようになってるんだよ！\n今日は何問解こうかなあ！",
    "6-6-11"   => "にににーにににーに？\nににににーににーにに！\nんにににににに、んににに、んににににに！\nにににに、にーにににー！\n----（訳）----\n君は読書って好きー？\n僕は大好きだよー！\nこの先どんな展開が待ってるんだろうとか、登場人物は今どんな気持ちなんだろうとかいろいろ考えちゃうよね！\n今日もお気に入りの本を読むんだあ！",
    "7-1-9"    => "ににー！\nんににー、にににーにににい！\nにににー、んにににに！\n----（訳）----\nもう夏だね！\n暑いときは扇風機の風にでもあたって気持ちよくなりたいなあ！\n熱中症には気を付けてね！",
    "7-18-18"  => "にににーににに？\nんににに、にににににー！\nにーにに、にににーにー！\n----（訳）----\n君は好きなテレビ番組ってあるー？\n僕は毎週金曜日の19時からやってる「タマえもん」が好きだよ！\n毎週楽しみなんだー！",
    "7-25-14"   => "にににー、ににに！\nにににににー、にっににに、んににに！\nににー、んにににー！\n----（訳）----\n最近はボール遊びにハマってるよ！\nなかなかうまくキャッチできないときもあるけど、そっちだよって言ってくれるときれいにとれるんだ！\nもっと練習しよー！",
    "8-10-13"    => "ににに～！\nににんにに、にににににーに！\nにににんににに～！\n----（訳）----\n暑い日が続くね～！\n水分補給もだいじだけど、冷たいおやつを食べるのもいいと思うよ！\n僕はスイカが食べたいなあ！",
    "9-15-3"    => "ににに、ににに～・・・。\n----（訳）----\nむにゃむにゃ、もう食べられないよ～・・・。（寝言）",
    "10-10-10"   => "にににーにーににに！\nにーにに、にににーにに、にににーんにににに！\nにーに、にーにににににーに！\n----（訳）----\n僕は最近算数の勉強を頑張ってるんだ！\n計算ミスしちゃうこともあるけど、少しずつ早く計算できるようになってるんだよ！\n今日は何問解こうかなあ！",
    "11-1-9"   => "にににー、んににに！\nんににに、にににー、ににんにに！\nにーにに、んににに～！\n----（訳）----\n秋って好きなんだあ！\n読書もしたいしスポーツもいいけど、やっぱ紅葉だよね！\n今年は見に行けるかな～！",
    "11-13-17"  => "にににーににに？\nんににに、にににににー！\nにーにに、にににーにー！\n----（訳）----\n君は好きなテレビ番組ってあるー？\n僕は毎週月曜日の19時からやってる「タマモン」が好きだよ！\n毎週楽しみなんだー！",
    "12-16-9"  => "ににんにに！\nにににー、にーににに～！\nにににに、んににーにに！\n----（訳）----\n最近だいぶ寒くなってきたね！\n冬と言ったらやっぱこたつだよね～！\nこたつの中でみかんを食べるのが好きなんだ！",
  }.freeze

  def perform
    now = Time.zone.now
    key = now.strftime('%-m-%-d-%-H')
    text = SCHEDULE[key]
    return unless text

    text_message = Line::Bot::V2::MessagingApi::TextMessage.new(
      text:)

    User.where(line_notifications_enabled: true)
        .joins(:authentications)
        .where(authentications: { provider: "line" })
        .pluck("authentications.uid")
        .each do |uid|
      push_req = Line::Bot::V2::MessagingApi::PushMessageRequest.new(to: uid, messages: [ text_message ])
      line_client.push_message(push_message_request: push_req)
    end

    Rails.logger.info "[SeasonalNotificationJob] #{key}の通知を完了しました。"
  end

  private

  def line_client
    @line_client ||= Line::Bot::V2::MessagingApi::ApiClient.new(
      channel_access_token: ENV.fetch("LINE_CHANNEL_TOKEN")
    )
  end
end
