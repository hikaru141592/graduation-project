# ゲームの進行とロジック

## 1. ゲーム画面の構成
ゲームプレイ画面において、画面全体は更新されず、以下の7箇所の要素のみが進行に応じて動的に更新される。  
- 行動選択ボタン（4つ）
- メッセージ表示部分
- キャラクターイラスト
- 背景イラスト

## 2. フェーズ構造と進行
ゲームは以下の2つのフェーズを交互に繰り返す構造で進行する。

### 2.1 行動選択可能フェーズ
- 画面には常に4つの行動選択ボタンが表示される。
- 選択可能なボタンは1〜4個。選択不可のボタンはラベルが空欄。
- プレイヤーが行動を選択すると、次の「行動選択後フェーズ」へ遷移する。

### 2.2 行動選択後フェーズ
- 行動を選択した後のメッセージを読み進めるためのフェーズ。
- 選択した行動に加え、その際のステータスや確率等に応じて結果が分岐する。
- 各行動結果はメッセージ、キャラクターイラスト、背景イラストの情報を持つ。
- このフェーズでは、行動選択ボタンの内容が固定で、「進める、(空欄)、(空欄)、(空欄)」となる。
- 各「進める」操作で1カット進行し、最後のカットの「進める」操作後に次の行動選択可能フェーズへ移行。
- カット数が0の場合は、行動選択後フェーズを経ずに直接次の行動選択可能フェーズに移行する。

## 3. イベント・イベントセットの構造

### 3.1 イベント
1つの「行動選択可能フェーズ」と、それの4つの選択肢に対応する「行動選択後フェーズ群」全体を1つのイベントと定義する。

### 3.2 派生イベント・イベントセット(MVP未実装)
- 特定のイベント中の特定の選択肢を選んだ場合のみ、次のイベントとして出現する特殊なイベント。
- 通常のイベントを「派生0」、その派生イベントを「派生1」「派生2」…と命名する。
- 派生元イベント（派生0）とその派生イベント群（派生1以降）を合わせて1つのイベントセットとする。

## 4. イベントカテゴリとイベントセット分類
イベントセットは以下のようにカテゴリ別に分類される：

| カテゴリ名     | イベントセット名                                       |
|----------------|------------------------------------------------------|
| 通常           | 何か言っている、何かしたそう                           |
| ルンルン       | 踊っている                                             |
| 泣いている     | 泣いている(空腹)、泣いている(よしよし不足)、泣いている(ランダム) |
| 怒っている(MVP未実装)     | 怒っている                                             |
| 夢中(MVP未実装)           | ブロックのおもちゃに夢中、マンガに夢中               |
| 眠そう(MVP未実装)         | 眠そう                                                 |
| 寝ている(MVP未実装)       | 寝ている                                               |

## 5. イベントセット選定ロジック

### 5.1 フラグ確認の優先順位
イベント終了時、以下の順にフラグの有効性を確認し、最初に条件を満たすイベントセットを選出：
- フラグ確認順：寝ている、泣いている(空腹)、泣いている(よしよし不足)、泣いている(ランダム)、怒っている、眠そう、ブロックのおもちゃに夢中、マンガに夢中、踊っている、何かしたそう、（該当なしの場合）何か言っている

### 5.2 フラグの発火条件
- 各イベントセットには発火条件があり、ステータス（満腹度、よしよし度、幸福度など）、日付、時間帯、確率などによって判定。
- ただし条件を満たしていても、一時的な無効状態になることがある(後述)。

## 6. イベントセットコールとループ構造

### 6.1 イベントセットコール(MVP未実装)
- 一部の行動により、フラグ確認をスキップして特定のイベントセットに直接遷移する処理。
- (後述の『解決』はイベントセットコールではない)

### 6.2 ループ構造のイベント(MVP未実装)
以下のカテゴリのイベントセットは「ループ型」となり、一定条件が満たされるまでイベント終了後同イベントへ接続される。

該当カテゴリ：
- ルンルン(ループ時間12分、後述の『解決』は存在しない)
- 泣いている(ループ時間60分)
- 怒っている(ループ時間60分)
- 眠そう(ループ時間12分、後述の『解決』は存在しない) 
- 寝ている(ループ時間90分、後述の『解決』は存在しない)  

- ループを終了させる条件１：特定の選択肢の選択イベントセットを選ぶことで、ループがなくなりイベント終了後通常通り次のイベントセットが選定される(『解決』と呼ぶ)。
- ループを終了させる条件２：該当イベントセットが発生してから1時間後に進める等の操作かページ再読み込みをする。
※
※寝ているに関してはフラグ発火条件が「一定の時間帯において確定で発生」とするため、ループ離脱後も一定時間帯内においては再度同ループへ接続される。
※眠そうに関してもフラグ発火条件が「一定の時間帯において確定で発生」とするため、他のイベントグループのフラグが優先して適用されない限りループ離脱後も一定時間帯内においては再度同ループへ接続される。

### 6.3 解決後のフラグ無効期間(MVP未実装)
イベントセットのループが解決された場合、同カテゴリのイベントセットのフラグは解決してから2時間無効。  
※イベントセットコールによる遷移は無効化対象ではない。

## 7. セーブ・再表示処理
- ログイン時またはページ更新時には、最後のプレイ状態（イベントの種類、フェーズの種類、カットの進行状況など）を復元。
- ただし、ループイベントの制限時間を超えていた場合はそのイベントセットを強制終了し、次のイベントセットへ遷移。
- 通常の「すすむ」操作によるイベント終了時(0カットのイベントの場合は行動選択時)に、ステータス更新とセーブが行われる。
- 時間制限を迎えた場合の強制終了時にはステータス更新等は行われない。
