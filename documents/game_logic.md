# ゲームの進行とロジック

## 1. フェーズ構造と進行
ゲームは以下の2つのフェーズを交互に繰り返す構造で進行する。

### 1.1 **行動選択可能フェーズ**
- 画面には常に4つの行動選択ボタンが表示される。
- 選択可能なボタンは1〜4個。選択不可のボタンはラベルが空欄、ボタンの塗り色が半透明になる。
- プレイヤーが行動を選択すると、次の「**行動選択後フェーズ**」へ遷移する。

### 1.2 **行動選択後フェーズ**
- 行動を選択した後のメッセージを読み進めるためのフェーズ。
- 選択した行動から得られる行動結果は、その際のステータスや確率等に応じて変化する。
- このフェーズでは、行動選択ボタンの内容が固定で、「つぎへ、(空欄)、(空欄)、(空欄)」となる。
  - ただし行動選択可能フェーズであっても選択肢が一つのみに設定されていて、「つぎへ、(空欄)、(空欄)、(空欄)」となる場合がある。
- 各行動結果はいくつかの**カット**から構成され、「つぎへ」ボタンを押すたびに次の**カット**へ移る。
  - 各**カット**はそれぞれメッセージ、キャラクターイラスト、背景イラストの情報を持つ。
  - 次の**カット**がない状態で「つぎへ」操作後に再度**行動選択可能フェーズ**へ移行、新しいイベントがステータスや確率等により選定される。
  - 行動結果が保持するカット数が0個の場合は、**行動選択後フェーズ**を経ずに直接次の**行動選択可能フェーズ**に移行する。

![画像](https://i.gyazo.com/2a3b2e94ac46974245b864baf7462cbc.png)

## 2. イベント・イベントセットの構造

### 2.1 **イベント**
1つの「行動選択」と、それの4つの選択肢から得られるすべての行動選択結果をまとめて1つの**イベント**と定義する。

### 2.2 **派生イベント**・**イベントセット**
- **派生イベント**とは特定のイベントにおいて特定の行動結果を得た場合のみ、次のイベントとして出現する特殊なイベントのこと。
- 通常のイベントを「派生0」、その派生イベントを「派生1」「派生2」…と命名する。
- 派生0イベントとその派生イベント群（派生1以降）を合わせて1つの**イベントセット**とする。

![画像](https://i.gyazo.com/5b945fd28b4a11ce7ec9a981626925aa.png)

## 3. イベントカテゴリとイベントセット分類
イベントセットは例えば以下のように**カテゴリ**別に分類される。

| カテゴリ名                | イベントセット名                                      |
|--------------------------|------------------------------------------------------|
| 通常                      | 何か言っている、何かしたそう                           |
| ルンルン                  | 踊っている                                            |
| 泣いている                | 泣いている(空腹)、泣いている(よしよし不足)、泣いている(ランダム) |
| 夢中                      | ブロックのおもちゃに夢中、マンガに夢中                   |

## 4. イベントセットの選定

### 4.1 フラグ確認の優先順位
- 通常の場合、イベント終了時に各イベントセット発生フラグの有効性を順に確認し、最初に条件を満たすイベントセットを選出。
- フラグ確認順は必ず一定の順となる。
  - 例えば、「寝ている」イベントセットが常に最優先である。
  - イベントセットを選出後、該当イベントセットの派生0のイベントの行動選択フェーズへ移行する。
- ただし前述の派生や、後述の**イベントセットコール**や**ループ処理**が適用される場合は、例外として通常のイベントセット選定が行われない。

### 4.2 フラグの発火条件
- 各イベントセットには発火条件がある。発火条件のタイプは以下の通りで、また複合条件（AND条件、OR条件）も存在する。
  - ステータス（満腹度が減ると泣く等）
  - 確率
  - 時間範囲（夜になると寝る等）
  - 日にち範囲（冬になるとコタツに入るようになる等）
  - 曜日（特定の曜日に特定のテレビ番組を見る等）
- ただし条件を満たしていても、一時的な無効状態になることがある(後述)。

## 5. 特殊なイベント（イベントセット）選定処理

### 5.1 派生
- 前述（2.2）の通り

### 5.1 **イベントセットコール**
- 一部の行動結果は、次のイベントセット選定のフラグ確認をスキップして、特定のイベントセットを強制的に呼び出す。

![画像](https://i.gyazo.com/2abbad10f757aee3026bf02fdb7dd46f.png)

### 5.2 ループ構造のイベント
- 一部のカテゴリのイベント（イベントセット）は「**ループ**型」となり、一定の条件を満たすまでイベント終了後同イベントへ接続される。
  - ループを終了させる条件１：特定の選択肢の選択イベントセットを選ぶことで、ループがなくなりイベント終了後通常通り次のイベントセットが選定される(『**解決**』と呼ぶ)。
  - ループを終了させる条件２：該当イベントセットが発生してから一定時間経過後に再アクセス（ページ再読み込み）をする。
- イベントセットのループが**解決**された場合、同カテゴリのイベントセットのフラグは**解決**してから2時間無効。
  - 時間経過によるループ終了は**解決**とはならない。
  - 無効状態であってもイベントセットコールによる遷移は適用される。
- 例えば「泣いている(よしよし不足)」イベントセットでは以下の通り。
  - 「よしよし」が選定される、もしくは20分以上経過後に再アクセスするまでループ。
  - 「よしよし」が選定された場合、**解決**となり、2時間はフラグを満たしても選出されなくなる。
  - 20分以上経過した場合ループを抜けるが、通常のイベントセット選定で選定されれば再度ループに突入。

![画像](https://i.gyazo.com/3e57f00181ef1196b63b789bdd19779a.png)

### 5.3 イベントセットごとにおける一日の発生回数の制限
- 一部のイベントセットは一日における発生回数に制限が存在する。
- ただしこの発生回数とは通常のイベントセット選定における選定回数で、イベントセットコールやループ等は対象とならない。

### 5.4 特殊なイベント遷移
- 一部のイベント（イベントセット）は上記のルールとは異なる特別なイベント遷移のルールを持つ。
  - 現状はカテゴリ「特訓」イベントのみ該当（「算数」イベントや「ボール遊び」イベントを連続で繰り返す）。

## 6. セーブ・再表示処理
- 各行動選択ボタンや、「つぎへ」ボタンを押すたびにプレイ状態のセーブが行われる（オートセーブ）。
- ログイン時またはページ更新時には、最後のプレイ状態（イベントの種類、フェーズの種類、行動選択結果、カットの進行状況）を復元。
- ただし、ループイベントの制限時間を超えていた場合はそのイベントを強制終了し、次のイベントセットへ遷移。

