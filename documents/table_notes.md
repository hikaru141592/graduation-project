# テーブル・カラム補足
各テーブルの意味のわかりにくいカラムのみ抜粋
  - [ER図](https://drive.google.com/file/d/1I5AovyKQ4KPsyWEap5AUllmAagCTPRBm/view?usp=sharing)と合わせてご覧ください。

## 1. イベント関連テーブル（eventsとその先祖と子孫のテーブル群）

## event\_categories
イベントセットをグループ化するカテゴリ。
  - 例えば「泣いている」カテゴリには「泣いている（よしよし不足）」イベントセットや「泣いている（ごはん不足）」等が属する。
  - ループイベントの「解決」が行われた場合、同カテゴリのイベントセットすべてが一定時間再発生しなくなる。

| カラム         | 意味                      |
| ------------- | ------------------------- |
| loop\_minutes | ループイベント継続時間（分） |

---

## event\_sets
「派生」で関連するイベント群。
  - 派生が存在しない場合、派生0のイベントのみを所有。
  - カテゴリに属する。

| カラム               | 意味                               |
| ------------------- | ---------------------------------- |
| trigger\_conditions | 出現条件（JSON）                    |
| daily\_limit        | 1日の最大出現回数（NULLなら制限なし） |

---

## events（イベント）
1回分の「行動選択可能フェーズ」を表す。action\_choicesを持つ。

| カラム              | 意味                        |
| ------------------ | --------------------------- |
| derivation\_number | 派生番号（0=通常、1以降=派生）|
| message            | 表示メッセージ               |
| character\_image   | 初期キャラ画像               |
| background\_image  | 初期背景画像                 |

---

## action\_choices
各イベントの行動選択フェーズに、画面に最大4つ表示されるボタンに対応するテーブル。

| カラム     | 意味               |
| --------- | ------------------ |
| position  | ボタンの位置（1〜4） |
| label     | ボタンに表示する文言 |

---

## action\_results
ユーザーが選んだ行動（action\_choice）の結果候補を定義。条件に応じてどの結果が選ばれるかが決まる。

| カラム                    | 意味                                                                  |
| ------------------------ | --------------------------------------------------------------------- |
| priority                 | 結果の優先順位（小さいほど先に判定）                                     |
| trigger\_conditions      | 発生条件（JSON）                                                       |
| effects                  | 結果によるステータス変化など（JSON）                                     |
| next\_derivation\_number | 次イベントの派生番号。同イベントセットの該当派生番号のイベントに遷移する。  |
| calls\_event\_set\_id    | 次に呼び出されるイベントセットを指定（イベントセットコール）。              |
| resolves\_loop           | ループイベントを終了させるかどうか                                       |

---

## cuts
行動結果の中でさらに細かく分割された「1コマ」を表現。メッセージと画像を組み合わせる単位。

| カラム              | 意味                                                |
| ------------------ | --------------------------------------------------- |
| position           | カット番号（1から順に進行）                            |
| message            | メッセージ、通常はこの内容が表示                       |
| messages           | ランダムメッセージを使用する場合に複数のメッセージを登録 |
| character\_image   | キャラクターの画像パス                                |
| background\_image  | 背景の画像パス                                       |

---

## 2. ユーザーとユーザーが必ず一つ保持するテーブル群

## users（ユーザー）

| カラム                                                     | 意味                |
| ------------------------------------------------------- | --------------------- |
| role                                                    | 権限（今後実装予定）    |
| line\_notifications\_enabled                            | LINE通知のON/OFF       |
| line\_friend\_linked                                    | LINEアカウント連携済みか |
| image\_change                                           | 画像差し替え許可フラグ（現状は仮画像への切り替えのみ、今後正式な形で実装） |
| name\_suffix                                            | 名前接尾辞              |

---

## user\_statuses（ユーザーステータス）
キャラクターの状態や成長要素を表すテーブル。

| カラム                                               | 意味                          |
| ------------------------------------------------- | ------------------------------- |
| happiness\_value                                  | 幸福度、なつき度（friendship）    |
| love\_value                                       | 「よしよし」すると増加。          |
| money                                             | 所持通貨（今後実装予定）          |
| current\_loop\_event\_set\_id                     | 現在進行中のループイベントセットID |
| current\_loop\_started\_at                        | ループ開始時刻                    |
| arithmetic\_training\_max\_count                  | 算数特訓の最高正解数              |
| arithmetic\_training\_fastest\_time               | 算数特訓の全問正解最速タイム      |
| ball\_training\_max\_count                        | ボール遊び特訓の最高記録          |
| vitality                                          | 体力（最大値）                   |
| temp\_vitality                                    | 一時体力                         |

---

## play\_states
プレイ進行状態。この情報を読み込むことで、ゲームプレイ画面に演出用のメッセージ/画像や行動選択ボタンを表示する。

| カラム                     | 意味             |
| ------------------------- | ---------------- |
| last\_line\_update\_at    | LINEのWebhookを用いたステータス更新などが行われた際にタイムスタンプを記録 |

---

## user\_event\_category\_invalidations（イベントカテゴリ無効化）
ループイベントの「解決後一定時間は再発生しない」仕組みを管理。

| カラム               | 意味       |
| ------------------- | ---------- |
| expires\_at         | 無効化終了時刻    |

---

## 3. ユーザーおよびイベントカテゴリ/イベントセットに関連するテーブル群（0..N）

## daily\_limit\_event\_set\_counts
イベントセットの「1日あたりの出現回数」を制御するための記録。

---

## event\_temporary\_data
特殊なイベントなどの進捗を一時的に保存。
  - 現状、特訓イベントでのみ使用

| カラム              | 意味          |
| ------------------ | -------        |
| reception\_count   | 受け取り回数               |
| success\_count     | 成功回数                   |
| started\_at        | 開始日時                   |
| ended\_at          | 終了日時                   |
| special\_condition | どのような特殊な状態かを表す |

---


